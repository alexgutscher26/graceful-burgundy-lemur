
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String     @id
  email         String     @unique
  name          String?
  role          UserRole   @default(user)
  status        UserStatus @default(ACTIVE)
  emailVerified Boolean    @default(false)
  image         String?
  phone         String?
  lastLoginAt   DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @default(now()) @updatedAt

  // Onboarding fields
  onboardingCompleted Boolean @default(false)
  onboardingData      Json?

  // Admin plugin fields
  banned        Boolean?
  banReason     String?
  banExpires    DateTime?

  // Relations
  sessions      Session[]
  accounts      Account[]
  workspaces    WorkspaceMember[]
  invitationsSent WorkspaceInvitation[]
  threads       Thread[]
  messages      Message[]
  wikiPages     WikiPage[]

  // Default workspace
  defaultWorkspaceId String?
  defaultWorkspace   Workspace? @relation("UserDefaultWorkspace", fields: [defaultWorkspaceId], references: [id], onDelete: SetNull)

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Active workspace context
  activeWorkspaceId String?
  activeWorkspace   Workspace? @relation(fields: [activeWorkspaceId], references: [id], onDelete: SetNull)

  // Admin plugin field for impersonation
  impersonatedBy String?

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

// Workspace model for multi-tenancy
model Workspace {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  members     WorkspaceMember[]
  invitations WorkspaceInvitation[]
  sessions    Session[]
  defaultForUsers User[] @relation("UserDefaultWorkspace")
  conversations Conversation[]

  @@map("workspace")
}

// Junction table for user-workspace relationship
model WorkspaceMember {
  id          String   @id @default(cuid())
  role        Role     @default(MEMBER)
  joinedAt    DateTime @default(now())

  // Relations
  userId      String
  workspaceId String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_member")
}

// Workspace invitation model
model WorkspaceInvitation {
  id          String   @id @default(cuid())
  email       String
  role        Role     @default(MEMBER)
  token       String   @unique @default(cuid())
  expiresAt   DateTime
  acceptedAt  DateTime?
  createdAt   DateTime @default(now())

  // Relations
  workspaceId String
  invitedById String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation(fields: [invitedById], references: [id])

  @@index([email])
  @@index([workspaceId])
  @@map("workspace_invitation")
}

// Role enum for workspace members
enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// User role enum for application-wide permissions
enum UserRole {
  user
  admin
}

// User account status enum
enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

// Conversation model for threaded discussions
model Conversation {
  id          String   @id @default(cuid())
  workspaceId String
  title       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  messages    Message[]
  threads     Thread[]
  wikiPages   WikiPage[]

  @@index([workspaceId])
  @@map("conversation")
}

// Thread model for organizing conversations
model Thread {
  id            String      @id @default(cuid())
  conversationId String
  title         String
  parentId      String?     // For nested threads
  createdBy     String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isDocumented  Boolean     @default(false)

  // Auto-documentation settings
  autoConvert   Boolean     @default(false)
  convertAfter  Int?        // Number of messages
  convertWhen   DateTime?   // Time-based conversion

  // Relations
  conversation  Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  parent        Thread?      @relation("ThreadHierarchy", fields: [parentId], references: [id])
  children      Thread[]     @relation("ThreadHierarchy")
  messages      Message[]
  wikiPage      WikiPage?
  creator       User         @relation(fields: [createdBy], references: [id])

  @@index([conversationId])
  @@index([createdBy])
  @@index([isDocumented])
  @@map("thread")
}

// Message model for individual messages
model Message {
  id             String      @id @default(cuid())
  threadId       String
  content        String
  contentType    MessageType @default(TEXT)
  createdBy      String
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Message metadata
  editedAt       DateTime?
  replyToId      String?     // For direct replies within threads

  // Relations
  thread         Thread      @relation(fields: [threadId], references: [id], onDelete: Cascade)
  replyTo        Message?    @relation("MessageReplies", fields: [replyToId], references: [id])
  replies        Message[]   @relation("MessageReplies")
  creator        User        @relation(fields: [createdBy], references: [id])

  @@index([threadId])
  @@index([createdBy])
  @@index([createdAt])
  @@map("message")
}

// WikiPage model for converted documentation
model WikiPage {
  id              String   @id @default(cuid())
  threadId        String   @unique
  title           String
  content         String   // Processed/markdown content
  summary         String?  // Auto-generated summary
  tags            String[] // Auto-extracted or manual tags
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Wiki organization
  category        String?
  isPublic        Boolean  @default(false)

  // Relations
  thread          Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  creator         User     @relation(fields: [createdBy], references: [id])

  @@index([threadId])
  @@index([createdBy])
  @@map("wiki_page")
}

// Message type enum
enum MessageType {
  TEXT
  CODE
  FILE
  IMAGE
  LINK
}
